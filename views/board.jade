//- views/board.jade
extends layout

block content
  //- Simple, readable UI theme (design-only changes)
  style.
    :root{
      --bg:#0e1320; --panel:#121a2b; --panel-soft:#0f1725;
      --text:#e6eaf2; --muted:#a6b0c3; --line:#1f2a3d;
      --brand:#7cb3ff; --brand-2:#b79cff;
      --ok:#34d399; --warn:#f59e0b; --bad:#f87171;
      --radius:14px; --shadow:0 14px 36px rgba(0,0,0,.4);
      --focus:0 0 0 4px rgba(124,179,255,.18);
    }
    body{
      background:
        radial-gradient(900px 600px at 10% 10%, rgba(124,179,255,.08), transparent 60%),
        radial-gradient(900px 600px at 90% 5%, rgba(183,156,255,.07), transparent 55%),
        linear-gradient(180deg, #0b1120, var(--bg));
      color:var(--text);
    }
    .wrap{max-width:1180px;margin:2rem auto;padding:0 1rem}
    .header{
      display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;
    }
    .brand{
      display:flex;align-items:center;gap:.6rem;
    }
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .brand h1{margin:0;font-size:1.15rem;letter-spacing:.2px;color:#dbe7ff}
    .card{
      background:linear-gradient(180deg, var(--panel), var(--panel-soft));
      border:1px solid var(--line); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:1.1rem; margin-bottom:1rem;
    }
    h2{margin:0 0 .75rem; font-size:clamp(1.2rem, 2.4vw, 1.6rem); letter-spacing:.2px}
    label{display:block; margin:.6rem 0 .3rem; font-weight:700; color:#d9e3f8; font-size:.95rem}
    input, select, textarea, button{
      width:100%; padding:.75rem .9rem; border-radius:12px;
      border:1px solid var(--line); background:#0b1426; color:var(--text);
      outline:none; transition:border-color .15s ease, box-shadow .15s ease, transform .05s ease;
    }
    input::placeholder, textarea::placeholder{color:#8c97ad}
    input:focus, select:focus, textarea:focus{border-color:var(--brand); box-shadow:var(--focus)}
    textarea{min-height:96px; resize:vertical}

    .row{display:flex; gap:14px; flex-wrap:wrap}
    .col{flex:1 1 320px; min-width:280px}
    .small{color:var(--muted); font-size:.92rem}

    /* Buttons */
    .btn{
      border:1px solid rgba(124,179,255,.45);
      background:linear-gradient(135deg, rgba(124,179,255,.18), rgba(183,156,255,.16));
      font-weight:800; cursor:pointer; letter-spacing:.2px;
      transition:filter .2s ease, transform .06s ease, box-shadow .2s ease;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btn-ghost{
      background:transparent; border:1px dashed var(--line); font-weight:700;
    }
    .btn-ghost:hover{border-color:rgba(124,179,255,.5)}

    /* Filter toolbar */
    .toolbar{display:flex; gap:10px; align-items:center; margin:.5rem 0 0; flex-wrap:wrap}
    .toolbar .btn{width:auto; padding:.6rem .9rem}

    /* Board grid */
    .board{display:grid; grid-template-columns:repeat(4, 1fr); gap:16px; margin-top:.5rem}
    @media (max-width:1100px){.board{grid-template-columns:repeat(2, 1fr)}}
    @media (max-width:720px){.board{grid-template-columns:1fr}}

    .column{
      background:linear-gradient(180deg, #0e172a, #0d1627);
      border:1px solid var(--line); border-radius:12px; padding:10px 10px 12px; min-height:160px;
    }
    .column h3{
      margin:6px 8px 8px; font-size:.98rem; font-weight:900; letter-spacing:.03em; color:#e2eaf7;
      display:flex; align-items:center; gap:.5rem;
    }
    .column h3::after{
      content:""; flex:1; height:1px; background:linear-gradient(90deg, rgba(255,255,255,.12), transparent);
    }
    .taskCol{list-style:none; padding:8px; margin:0; display:flex; flex-direction:column; gap:10px}

    /* Task card */
    .task{
      border:1px solid var(--line); border-radius:12px; background:#0c1528;
      padding:.8rem .9rem; transition:transform .1s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .task:hover{transform:translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.35); border-color:rgba(124,179,255,.45)}
    .task .title{font-weight:900; letter-spacing:.015em; margin-bottom:2px}
    .task .meta{color:var(--muted); font-size:.9rem; margin-top:4px}

    .badge{display:inline-block; padding:.22rem .55rem; border-radius:999px; font-size:.75rem; margin-left:6px; font-weight:800}
    .badge.ontrack{background:rgba(52,211,153,.15); border:1px solid rgba(52,211,153,.55); color:#22c55e}
    .badge.atrisk{background:rgba(245,158,11,.15); border:1px solid rgba(245,158,11,.55); color:#f59e0b}
    .badge.overdue{background:rgba(248,113,113,.15); border:1px solid rgba(248,113,113,.55); color:#f87171}

    .actions{margin-top:.65rem; display:flex; gap:8px; flex-wrap:wrap}
    .actions select{flex:0 1 180px}

  .wrap
    .header
      .brand
        .dot
        h1 Task Board
      //- Keep actions area minimal (no JS hooks here)
      span.small Manage your tasks with focus and clarity.

    section.card
      h2 Create Task
      form#taskForm
        .row
          .col
            label(for='tTitle') Title
            input#tTitle(type='text' placeholder='Short title' required)
            label(for='tPriority') Priority
            select#tPriority
              option(value='Low') Low
              option(value='Medium' selected) Medium
              option(value='High') High
          .col
            label(for='tAssignee') Assignee (user id)
            input#tAssignee(type='number' placeholder='e.g., 1')
            label(for='tDue') Due Date/Time
            input#tDue(type='datetime-local')
        label(for='tDesc') Description
        textarea#tDesc(placeholder='A few details…')
        button.btn(type='submit') Create

    section.card
      h2 Filters
      .row
        .col
          label(for='fAssignee') Assignee (user id)
          input#fAssignee(type='number' placeholder='e.g., 1')
        .col
          label(for='fPriority') Priority
          select#fPriority
            option(value='') (any)
            option(value='Low') Low
            option(value='Medium') Medium
            option(value='High') High
      .toolbar
        button.btn#applyFilters Apply Filters
        button.btn-ghost#clearFilters(type='button') Clear

    section.card
      h2 Board
      p.small Click “Refresh” to reload tasks; use Change Status / Add Comment on each card.
      .toolbar
        button.btn#refreshTasks Refresh
        a.btn(href="/tasks/view" style="text-decoration:none;") Open Task Viewer →
      .board
        .column
          h3 Backlog
          ul#colBacklog.taskCol
        .column
          h3 In Progress
          ul#colInProgress.taskCol
        .column
          h3 Review
          ul#colReview.taskCol
        .column
          h3 Done
          ul#colDone.taskCol

  //- Client JS (unchanged; design-only request)
  script.
    (function(){
      const taskForm = document.getElementById('taskForm');
      const refreshBtn = document.getElementById('refreshTasks');
      const applyFiltersBtn = document.getElementById('applyFilters');
      const clearFiltersBtn = document.getElementById('clearFilters');
      const fAssignee = document.getElementById('fAssignee');
      const fPriority = document.getElementById('fPriority');

      const cols = {
        'Backlog': document.getElementById('colBacklog'),
        'In Progress': document.getElementById('colInProgress'),
        'Review': document.getElementById('colReview'),
        'Done': document.getElementById('colDone')
      };

      let JWT = localStorage.getItem('token') || '';
      function authHeaders(){ return JWT ? { Authorization:'Bearer '+JWT } : {}; }
      function toISOLocal(dt){ if(!dt) return null; const d=new Date(dt); return isNaN(d)?null:d.toISOString(); }
      function el(tag, attrs={}, children=[]){
        const e=document.createElement(tag);
        Object.entries(attrs).forEach(([k,v])=>{ k==='class'? e.className=v : e.setAttribute(k,v); });
        (Array.isArray(children)?children:[children]).forEach(c=>{ if(c==null) return; typeof c==='string'? e.appendChild(document.createTextNode(c)) : e.appendChild(c); });
        return e;
      }
      function clearBoard(){ Object.values(cols).forEach(ul=>ul.innerHTML=''); }
      function emptyState(ul){
        const d=el('div',{class:'small'},'No tasks here yet.');
        ul.appendChild(d);
      }
      function renderTaskItem(t){
        const li=el('li',{class:'task'});
        li.appendChild(el('div',{class:'title'}, t.title+' '));
        li.appendChild(el('span',{class:'badge '+t.statusBadge.replace(' ','').toLowerCase()}, t.statusBadge));
        li.appendChild(el('div',{class:'meta'}, `P:${t.priority} · Assignee:${t.assigneeId ?? '-'} · Due:${t.dueDate ? new Date(t.dueDate).toLocaleString() : '-'}`));

        const sel=el('select');
        ['Backlog','In Progress','Review','Done'].forEach(s=>{
          const opt=el('option',{value:s},s); if(s===t.status) opt.selected=true; sel.appendChild(opt);
        });
        const moveBtn=el('button',{class:'btn'},'Change Status');
        moveBtn.onclick=async()=>{
          const res=await fetch(`/tasks/${t.id}`,{
            method:'PATCH', headers:{'Content-Type':'application/json',...authHeaders()},
            body: JSON.stringify({ status: sel.value })
          });
          if(!res.ok) return alert('Failed to move');
          loadTasks();
        };

        const cInp=el('input',{type:'text',placeholder:'Add comment…'});
        const cBtn=el('button',{class:'btn-ghost'},'Add Comment');
        cBtn.onclick=async()=>{
          if(!cInp.value.trim()) return;
          const res=await fetch(`/tasks/${t.id}/comments`,{
            method:'POST', headers:{'Content-Type':'application/json',...authHeaders()},
            body: JSON.stringify({ body: cInp.value.trim() })
          });
          if(!res.ok) return alert('Failed to comment');
          cInp.value=''; alert('Comment added');
        };

        li.appendChild(el('div',{class:'actions'},[sel,moveBtn,cInp,cBtn]));
        return li;
      }
      async function loadTasks(){
        const params=new URLSearchParams();
        if(fAssignee.value) params.set('assigneeId', String(fAssignee.value));
        if(fPriority.value) params.set('priority', fPriority.value);
        const res=await fetch('/tasks?'+params.toString(),{ headers: authHeaders() });
        if(!res.ok) return alert('Failed to load tasks');
        const data=await res.json();
        clearBoard();
        const buckets={'Backlog':[], 'In Progress':[], 'Review':[], 'Done':[]};
        (data.tasks||[]).forEach(t=> buckets[t.status]?.push(t));
        Object.entries(buckets).forEach(([status, arr])=>{
          const ul=cols[status];
          if(!arr.length) return emptyState(ul);
          arr.forEach(t=> (ul.appendChild(renderTaskItem(t))));
        });
      }

      taskForm.onsubmit=async(e)=>{
        e.preventDefault();
        const payload={
          title: document.getElementById('tTitle').value.trim(),
          description: document.getElementById('tDesc').value,
          priority: document.getElementById('tPriority').value,
          assigneeId: document.getElementById('tAssignee').value ? Number(document.getElementById('tAssignee').value) : null,
          dueDate: toISOLocal(document.getElementById('tDue').value)
        };
        const res=await fetch('/tasks',{
          method:'POST', headers:{'Content-Type':'application/json',...authHeaders()},
          body: JSON.stringify(payload)
        });
        const data=await res.json();
        if(!res.ok) return alert(data.error || 'Create failed');
        e.target.reset();
        loadTasks();
      };

      refreshBtn.onclick=loadTasks;
      applyFiltersBtn.onclick=loadTasks;
      clearFiltersBtn.onclick=()=>{ fAssignee.value=''; fPriority.value=''; loadTasks(); };

      if(JWT) loadTasks();
    })();
