//- views/board.jade
extends layout

block content
  //- Simple, readable UI theme (design-only changes)
  style.
    :root{
      --bg:#0f1220;
      --panel:#141a2a;
      --panel-soft:#101726;
      --line:#22304a;
      --text:#e9edf6;
      --muted:#9aa8c0;
      --brand:#8bb7ff;
      --ok:#34d399; --warn:#f59e0b; --bad:#f87171;
      --radius:12px; --shadow:0 8px 22px rgba(0,0,0,.35);
      --focus:0 0 0 3px rgba(139,183,255,.18);
    }
    body{
      background: linear-gradient(180deg, #0d1220, var(--bg));
      color:var(--text);
      margin:0;
    }
    .wrap{max-width:1100px;margin:1.5rem auto;padding:0 1rem}
    .header{
      display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;
    }
    .brand{display:flex;align-items:center;gap:.6rem}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .brand h1{margin:0;font-size:1.05rem;letter-spacing:.2px;color:#dbe7ff}
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:1rem;
      margin-bottom:.9rem;
    }
    h2{margin:0 0 .6rem; font-size:1.1rem; letter-spacing:.15px}
    label{display:block; margin:.5rem 0 .3rem; font-weight:700; color:#dfe6fb; font-size:.92rem}
    input, select, textarea, button{
      width:100%; padding:.7rem .85rem; border-radius:10px;
      border:1px solid var(--line); background:#0f1626; color:var(--text);
      outline:none; transition:border-color .12s ease, box-shadow .12s ease, transform .05s ease;
    }
    input::placeholder, textarea::placeholder{color:#8c97ad}
    input:focus, select:focus, textarea:focus{border-color:var(--brand); box-shadow:var(--focus)}
    textarea{min-height:90px; resize:vertical}

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1 1 320px; min-width:260px}
    .small{color:var(--muted); font-size:.9rem}

    /* Buttons */
    .btn{
      border:1px solid rgba(139,183,255,.45);
      background:#0f1728;
      font-weight:800; cursor:pointer; letter-spacing:.2px;
      transition:filter .15s ease, transform .05s ease, box-shadow .15s ease;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btn-ghost{
      background:transparent; border:1px dashed var(--line); font-weight:700;
    }
    .btn-ghost:hover{border-color:rgba(139,183,255,.5)}

    /* Filter toolbar */
    .toolbar{display:flex; gap:10px; align-items:center; margin:.5rem 0 0; flex-wrap:wrap}
    .toolbar .btn{width:auto; padding:.55rem .85rem}

    /* Board grid */
    .board{display:grid; grid-template-columns:repeat(4, 1fr); gap:14px; margin-top:.4rem}
    @media (max-width:1100px){.board{grid-template-columns:repeat(2, 1fr)}}
    @media (max-width:720px){.board{grid-template-columns:1fr}}

    .column{
      background:var(--panel-soft);
      border:1px solid var(--line); border-radius:10px; padding:10px; min-height:150px;
    }
    .column h3{
      margin:4px 6px 8px; font-size:.96rem; font-weight:900; letter-spacing:.02em; color:#e3ebfa;
    }
    .taskCol{list-style:none; padding:6px; margin:0; display:flex; flex-direction:column; gap:8px}

    /* Task card */
    .task{
      border:1px solid var(--line); border-radius:10px; background:#0f1728;
      padding:.7rem .8rem; transition:transform .1s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .task:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.32); border-color:rgba(139,183,255,.4)}
    .task .title{font-weight:900; letter-spacing:.01em; margin-bottom:2px}
    .task .meta{color:var(--muted); font-size:.88rem; margin-top:4px}

    .badge{display:inline-block; padding:.18rem .5rem; border-radius:999px; font-size:.72rem; margin-left:6px; font-weight:800}
    .badge.ontrack{background:rgba(52,211,153,.12); border:1px solid rgba(52,211,153,.5); color:#22c55e}
    .badge.atrisk{background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.5); color:#f59e0b}
    .badge.overdue{background:rgba(248,113,113,.12); border:1px solid rgba(248,113,113,.5); color:#f87171}

    .actions{margin-top:.6rem; display:flex; gap:8px; flex-wrap:wrap}
    .actions select{flex:0 1 180px}

  .wrap
    .header
      .brand
        .dot
        h1 Task Board
      span.small Keep it light and clear.

    section.card
      h2 Create Task
      form#taskForm
        .row
          .col
            label(for='tTitle') Title
            input#tTitle(type='text' placeholder='Short title' required)
            label(for='tPriority') Priority
            select#tPriority
              option(value='Low') Low
              option(value='Medium' selected) Medium
              option(value='High') High
          .col
            label(for='tAssignee') Assignee (user id)
            input#tAssignee(type='number' placeholder='e.g., 1')
            label(for='tDue') Due Date/Time
            input#tDue(type='datetime-local')
        label(for='tDesc') Description
        textarea#tDesc(placeholder='A few details…')
        button.btn(type='submit') Create

    section.card
      h2 Filters
      .row
        .col
          label(for='fAssignee') Assignee (user id)
          input#fAssignee(type='number' placeholder='e.g., 1')
        .col
          label(for='fPriority') Priority
          select#fPriority
            option(value='') (any)
            option(value='Low') Low
            option(value='Medium') Medium
            option(value='High') High
      .toolbar
        button.btn#applyFilters Apply Filters
        button.btn-ghost#clearFilters(type='button') Clear

    section.card
      h2 Board
      p.small Click “Refresh” to reload tasks; use Change Status / Add Comment on each card.
      .toolbar
        button.btn#refreshTasks Refresh
        a.btn(href="/tasks/view" style="text-decoration:none;") Open Task Viewer →
      .board
        .column
          h3 Backlog
          ul#colBacklog.taskCol
        .column
          h3 In Progress
          ul#colInProgress.taskCol
        .column
          h3 Review
          ul#colReview.taskCol
        .column
          h3 Done
          ul#colDone.taskCol

  //- Client JS (unchanged; design-only request)
  script.
    (function(){
      const taskForm = document.getElementById('taskForm');
      const refreshBtn = document.getElementById('refreshTasks');
      const applyFiltersBtn = document.getElementById('applyFilters');
      const clearFiltersBtn = document.getElementById('clearFilters');
      const fAssignee = document.getElementById('fAssignee');
      const fPriority = document.getElementById('fPriority');

      const cols = {
        'Backlog': document.getElementById('colBacklog'),
        'In Progress': document.getElementById('colInProgress'),
        'Review': document.getElementById('colReview'),
        'Done': document.getElementById('colDone')
      };

      let JWT = localStorage.getItem('token') || '';
      function authHeaders(){ return JWT ? { Authorization:'Bearer '+JWT } : {}; }
      function toISOLocal(dt){ if(!dt) return null; const d=new Date(dt); return isNaN(d)?null:d.toISOString(); }
      function el(tag, attrs={}, children=[]){
        const e=document.createElement(tag);
        Object.entries(attrs).forEach(([k,v])=>{ k==='class'? e.className=v : e.setAttribute(k,v); });
        (Array.isArray(children)?children:[children]).forEach(c=>{ if(c==null) return; typeof c==='string'? e.appendChild(document.createTextNode(c)) : e.appendChild(c); });
        return e;
      }
      function clearBoard(){ Object.values(cols).forEach(ul=>ul.innerHTML=''); }
      function emptyState(ul){
        const d=el('div',{class:'small'},'No tasks here yet.');
        ul.appendChild(d);
      }
      function renderTaskItem(t){
        const li=el('li',{class:'task'});
        li.appendChild(el('div',{class:'title'}, t.title+' '));
        li.appendChild(el('span',{class:'badge '+t.statusBadge.replace(' ','').toLowerCase()}, t.statusBadge));
        li.appendChild(el('div',{class:'meta'}, `P:${t.priority} · Assignee:${t.assigneeId ?? '-'} · Due:${t.dueDate ? new Date(t.dueDate).toLocaleString() : '-'}`));

        const sel=el('select');
        ['Backlog','In Progress','Review','Done'].forEach(s=>{
          const opt=el('option',{value:s},s); if(s===t.status) opt.selected=true; sel.appendChild(opt);
        });
        const moveBtn=el('button',{class:'btn'},'Change Status');
        moveBtn.onclick=async()=>{
          const res=await fetch(`/tasks/${t.id}`,{
            method:'PATCH', headers:{'Content-Type':'application/json',...authHeaders()},
            body: JSON.stringify({ status: sel.value })
          });
          if(!res.ok) return alert('Failed to move');
          loadTasks();
        };

        const cInp=el('input',{type:'text',placeholder:'Add comment…'});
        const cBtn=el('button',{class:'btn-ghost'},'Add Comment');
        cBtn.onclick=async()=>{
          if(!cInp.value.trim()) return;
          const res=await fetch(`/tasks/${t.id}/comments`,{
            method:'POST', headers:{'Content-Type':'application/json',...authHeaders()},
            body: JSON.stringify({ body: cInp.value.trim() })
          });
          if(!res.ok) return alert('Failed to comment');
          cInp.value=''; alert('Comment added');
        };

        li.appendChild(el('div',{class:'actions'},[sel,moveBtn,cInp,cBtn]));
        return li;
      }
      async function loadTasks(){
        const params=new URLSearchParams();
        if(fAssignee.value) params.set('assigneeId', String(fAssignee.value));
        if(fPriority.value) params.set('priority', fPriority.value);
        const res=await fetch('/tasks?'+params.toString(),{ headers: authHeaders() });
        if(!res.ok) return alert('Failed to load tasks');
        const data=await res.json();
        clearBoard();
        const buckets={'Backlog':[], 'In Progress':[], 'Review':[], 'Done':[]};
        (data.tasks||[]).forEach(t=> buckets[t.status]?.push(t));
        Object.entries(buckets).forEach(([status, arr])=>{
          const ul=cols[status];
          if(!arr.length) return emptyState(ul);
          arr.forEach(t=> (ul.appendChild(renderTaskItem(t))));
        });
      }

      taskForm.onsubmit=async(e)=>{
        e.preventDefault();
        const payload={
          title: document.getElementById('tTitle').value.trim(),
          description: document.getElementById('tDesc').value,
          priority: document.getElementById('tPriority').value,
          assigneeId: document.getElementById('tAssignee').value ? Number(document.getElementById('tAssignee').value) : null,
          dueDate: toISOLocal(document.getElementById('tDue').value)
        };
        const res=await fetch('/tasks',{
          method:'POST', headers:{'Content-Type':'application/json',...authHeaders()},
          body: JSON.stringify(payload)
        });
        const data=await res.json();
        if(!res.ok) return alert(data.error || 'Create failed');
        e.target.reset();
        loadTasks();
      };

      refreshBtn.onclick=loadTasks;
      applyFiltersBtn.onclick=loadTasks;
      clearFiltersBtn.onclick=()=>{ fAssignee.value=''; fPriority.value=''; loadTasks(); };

      if(JWT) loadTasks();
    })();
